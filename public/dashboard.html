<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thaya Dashboard</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background-color:#f8f9fa; }
    .card-metric { min-width: 180px; }
    .input-width { max-width:200px; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-dark bg-dark mb-4">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1">THAYA Chatbot Dashboard</span>
    </div>
  </nav>

  <div class="container mb-5">
    <!-- Metric Cards -->
    <div class="row g-3 align-items-end mb-3">
      <div class="col-auto">
        <label class="form-label mb-0">จากวันที่</label>
        <input type="date" id="startDate" class="form-control" />
      </div>
      <div class="col-auto">
        <label class="form-label mb-0">ถึงวันที่</label>
        <input type="date" id="endDate" class="form-control" />
      </div>
      <div class="col-auto">
        <button id="applyFilter" class="btn btn-outline-primary">กรองข้อมูล</button>
        <button id="clearFilter" class="btn btn-outline-secondary ms-1">ล้าง</button>
      </div>
    </div>

    <div class="row g-3" id="metricRow"></div>

    <!-- Chart -->
    <div class="card mt-4">
      <div class="card-header">กราฟจำนวนข้อความต่อเพจ</div>
      <div class="card-body">
        <canvas id="msgChart" height="120"></canvas>
      </div>
    </div>

    <!-- Stats Table -->
    <div class="card mt-4">
      <div class="card-header">รายละเอียดสถิติ</div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-striped mb-0" id="statsTable">
            <thead class="table-light">
              <tr><th>Page Key</th><th>Page Name</th><th class="text-end">Unique Users</th><th class="text-end">Total Messages</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Page Management -->
    <div class="card mt-5">
      <div class="card-header">จัดการเพจ</div>
      <div class="card-body">
        <div class="row g-2 align-items-end mb-3">
          <div class="col-auto">
            <label class="form-label">Page Key</label>
            <input type="text" id="newPageKey" class="form-control input-width" placeholder="page14" />
          </div>
          <div class="col-auto">
            <label class="form-label">ชื่อเพจ</label>
            <input type="text" id="newPageName" class="form-control input-width" placeholder="THAYA Shop" />
          </div>
          <div class="col-auto">
            <button id="addBtn" class="btn btn-success">เพิ่มเพจ</button>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-hover" id="pagesTable">
            <thead class="table-light">
              <tr><th>Page Key</th><th>Page Name</th><th style="width:120px">Action</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    let chart;

    async function fetchJSON(url, options) {
      const res = await fetch(url, options);
      return res.json();
    }

    function numberFmt(n){ return n.toLocaleString('th-TH'); }

    function renderMetrics(stats){
      const metricRow=document.getElementById('metricRow');
      metricRow.innerHTML='';
      let totalUsers=0,totalMsgs=0;
      stats.forEach(s=>{ totalUsers+=s.uniqueUsers; totalMsgs+=s.totalMessages; });
      const metrics=[
        {title:'เพจที่เชื่อมต่อ', value:stats.length},
        {title:'ผู้ใช้ทั้งหมด', value:totalUsers},
        {title:'ข้อความทั้งหมด', value:totalMsgs}
      ];
      metrics.forEach(m=>{
        const col=document.createElement('div');
        col.className='col-auto';
        col.innerHTML=`<div class="card card-metric text-center"><div class="card-body"><h5 class="card-title">${m.title}</h5><h3 class="card-text">${numberFmt(m.value)}</h3></div></div>`;
        metricRow.appendChild(col);
      });
    }

    function renderTable(stats){
      const tbody=document.querySelector('#statsTable tbody');
      tbody.innerHTML='';
      stats.forEach(row=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${row.pageKey}</td><td>${row.pageName}</td><td class="text-end">${numberFmt(row.uniqueUsers)}</td><td class="text-end">${numberFmt(row.totalMessages)}</td>`;
        tbody.appendChild(tr);
      });
    }

    function renderChart(stats){
      const ctx=document.getElementById('msgChart');
      const labels=stats.map(s=>s.pageName||s.pageKey);
      const data=stats.map(s=>s.totalMessages);
      if(chart){ chart.destroy(); }
      chart=new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Total Messages',data,backgroundColor:'#0d6efd'}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
    }

    async function loadStats(){
      let url='/api/stats';
      const s=document.getElementById('startDate').value;
      const e=document.getElementById('endDate').value;
      const qs=[];
      if(s) qs.push(`start=${s}`);
      if(e) qs.push(`end=${e}`);
      if(qs.length) url += '?' + qs.join('&');
      const json=await fetchJSON(url);
      const stats=json.data||[];
      renderMetrics(stats);
      renderTable(stats);
      renderChart(stats);
    }

    async function loadPages(){
      const json=await fetchJSON('/api/pages');
      const tbody=document.querySelector('#pagesTable tbody');
      tbody.innerHTML='';
      json.data.forEach(p=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${p.pageKey}</td><td><input class="form-control form-control-sm" data-key="${p.pageKey}" value="${p.pageName||''}" /></td><td><button class="btn btn-primary btn-sm saveBtn" data-key="${p.pageKey}">บันทึก</button></td>`;
        tbody.appendChild(tr);
      });
    }

    async function init(){
      await loadStats();
      await loadPages();
      // refresh ทุก 60 วินาที
      setInterval(loadStats,60000);
    }

    document.addEventListener('DOMContentLoaded',init);

    document.getElementById('addBtn').addEventListener('click',async()=>{
      const keyEl=document.getElementById('newPageKey');
      const nameEl=document.getElementById('newPageName');
      const pageKey=keyEl.value.trim();
      const pageName=nameEl.value.trim();
      if(!pageKey) return alert('กรุณาระบุ pageKey');
      await fetchJSON('/api/pages',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({pageKey,pageName})});
      keyEl.value='';nameEl.value='';
      await loadPages();await loadStats();
    });

    document.addEventListener('click',async e=>{
      if(e.target.classList.contains('saveBtn')){
        const pageKey=e.target.dataset.key;
        const input=document.querySelector(`input[data-key="${pageKey}"]`);
        const pageName=input.value.trim();
        await fetchJSON(`/api/pages/${pageKey}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({pageName})});
        await loadPages();await loadStats();
      }
    });

    document.getElementById('applyFilter').addEventListener('click', loadStats);
    document.getElementById('clearFilter').addEventListener('click', () => {
      document.getElementById('startDate').value='';
      document.getElementById('endDate').value='';
      loadStats();
    });
  </script>
</body>
</html> 